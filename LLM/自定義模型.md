æ§‹å»ºè‡ªå®šç¾©æ¨¡å‹
ğŸ¤— Transformers åº«æ—¨åœ¨æ˜“äºæ“´å±•ã€‚æ¯å€‹æ¨¡å‹éƒ½åœ¨å€‰åº«çš„çµ¦å®šå­æ–‡ä»¶å¤¾ä¸­å®Œå…¨ç·¨ç¢¼ï¼Œæ²’æœ‰æŠ½è±¡ï¼Œå› æ­¤æ‚¨å¯ä»¥è¼•æ¾åœ°å¾©åˆ¶æ¨¡å‹æ–‡ä»¶å¹¶æ ¹æ“šæ‚¨çš„éœ€è¦é€²è¡Œèª¿æ•´ã€‚

å¦‚æœæ‚¨æ­£åœ¨ç·¨å¯«å…¨æ–°çš„æ¨¡å‹ï¼Œå¾é ­é–‹å§‹å¯èƒ½æ›´å®¹æ˜“ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å€‘å°‡å‘æ‚¨å±•ç¤ºå¦‚ä½•ç·¨å¯«è‡ªå®šç¾©æ¨¡å‹åŠå…¶é…ç½®ï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨ Transformers ä¸­ä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•èˆ‡ç¤¾å€å…±äº«å®ƒï¼ˆä»¥åŠå®ƒæ‰€ä¾è³´çš„ä»£ç¢¼ï¼‰ï¼Œä»¥ä¾¿ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨å®ƒï¼Œå³ä½¿å®ƒä¸åœ¨ ğŸ¤— Transformers åº«ä¸­ã€‚æˆ‘å€‘å°‡çœ‹åˆ°å¦‚ä½•æ§‹å»ºåœ¨ transformers ä¹‹ä¸Šï¼Œå¹¶ä½¿ç”¨æ‚¨çš„é‰¤å­å’Œè‡ªå®šç¾©ä»£ç¢¼æ“´å±•æ¡†æ¶ã€‚

æˆ‘å€‘å°‡é€šéå°‡ timm åº« çš„ ResNet é¡å°è£åˆ° PreTrainedModel ä¸­ï¼Œåœ¨ ResNet æ¨¡å‹ä¸Šèªªæ˜æ‰€æœ‰é€™äº›å…§å®¹ã€‚

ç·¨å¯«è‡ªå®šç¾©é…ç½®
åœ¨æˆ‘å€‘æ·±å…¥æ¨¡å‹ä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆç·¨å¯«å®ƒçš„é…ç½®ã€‚æ¨¡å‹çš„é…ç½®æ˜¯ä¸€å€‹å°è±¡ï¼Œå®ƒå°‡åŒ…å«æ§‹å»ºæ¨¡å‹æ‰€éœ€çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚æ­£å¦‚æˆ‘å€‘å°‡åœ¨ä¸‹ä¸€ç¯€ä¸­çœ‹åˆ°çš„é‚£æ¨£ï¼Œæ¨¡å‹åªèƒ½æ¥æ”¶ä¸€å€‹ config ä¾†åˆå§‹åŒ–ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦é€™å€‹å°è±¡ç›¡å¯èƒ½å®Œæ•´ã€‚

transformers åº«æœ¬èº«ä¸­çš„æ¨¡å‹é€šå¸¸éµå¾ªé€™æ¨£çš„ç´„å®šï¼šå®ƒå€‘åœ¨ __init__ æ–¹æ³•ä¸­æ¥å—ä¸€å€‹ config å°è±¡ï¼Œç„¶å¾Œå°‡æ•´å€‹ config å‚³éçµ¦æ¨¡å‹ä¸­çš„å­å±¤ï¼Œè€Œä¸æ˜¯å°‡ config å°è±¡åˆ†è§£æˆå¤šå€‹åƒæ•¸ï¼Œé€™äº›åƒæ•¸éƒ½å–®ç¨å‚³éçµ¦å­å±¤ã€‚ä»¥é€™ç¨®æ–¹å¼ç·¨å¯«æ‚¨çš„æ¨¡å‹æœƒå°è‡´ä»£ç¢¼æ›´ç°¡å–®ï¼Œå¹¶çˆ²ä»»ä½•è¶…åƒæ•¸æä¾›æ¸…æ™°çš„â€œçœŸç›¸ä¾†æºâ€ï¼Œä¹Ÿä½¿å®ƒæ›´å®¹æ˜“é‡ç”¨ transformers ä¸­å…¶ä»–æ¨¡å‹çš„ä»£ç¢¼ã€‚

åœ¨æˆ‘å€‘çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘å€‘å°‡é‡‡ç”¨ ResNet é¡ä¸­æˆ‘å€‘å¯èƒ½å¸Œæœ›èª¿æ•´çš„å¹¾å€‹åƒæ•¸ã€‚ä¸åŒçš„é…ç½®å°‡çµ¦æˆ‘å€‘ä¸åŒçš„ ResNet é¡å‹ã€‚ç„¶å¾Œæˆ‘å€‘åªå­˜å„²é€™äº›åƒæ•¸ï¼Œå¹¶åœ¨æª¢æŸ¥å…¶ä¸­ä¸€äº›åƒæ•¸çš„æœ‰æ•ˆæ€§å¾Œã€‚

from transformers import PretrainedConfig
from typing import List


class ResnetConfig(PretrainedConfig):
    model_type = "resnet"

    def __init__(
        self,
        block_type="bottleneck",
        layers: List[int] = [3, 4, 6, 3],
        num_classes: int = 1000,
        input_channels: int = 3,
        cardinality: int = 1,
        base_width: int = 64,
        stem_width: int = 64,
        stem_type: str = "",
        avg_down: bool = False,
        **kwargs,
    ):
        if block_type not in ["basic", "bottleneck"]:
            raise ValueError(f"`block_type` must be 'basic' or bottleneck', got {block_type}.")
        if stem_type not in ["", "deep", "deep-tiered"]:
            raise ValueError(f"`stem_type` must be '', 'deep' or 'deep-tiered', got {stem_type}.")

        self.block_type = block_type
        self.layers = layers
        self.num_classes = num_classes
        self.input_channels = input_channels
        self.cardinality = cardinality
        self.base_width = base_width
        self.stem_width = stem_width
        self.stem_type = stem_type
        self.avg_down = avg_down
        super().__init__(**kwargs)
ç·¨å¯«è‡ªå·±çš„é…ç½®æ™‚ï¼Œè¦è¨˜ä½ä¸‰å€‹é‡è¦äº‹é …ï¼š

æ‚¨å¿…é ˆç¹¼æ‰¿è‡ª PretrainedConfigï¼Œ
æ‚¨çš„ PretrainedConfig çš„ __init__ å¿…é ˆæ¥å—ä»»ä½• kwargsï¼Œ
é€™äº› kwargs éœ€è¦å‚³éçµ¦è¶…é¡ __init__ã€‚
ç¹¼æ‰¿æ˜¯çˆ²äº†ç¡®ä¿æ‚¨å¾ ğŸ¤— Transformers åº«ä¸­ç²å¾—æ‰€æœ‰åŠŸèƒ½ï¼Œè€Œå¦å¤–å…©å€‹ç´„æŸä¾†è‡ª PretrainedConfig æ“æœ‰æ¯”æ‚¨æ­£åœ¨è¨­ç½®çš„å­—æ®µæ›´å¤šçš„å­—æ®µã€‚ç•¶ä½¿ç”¨ from_pretrained æ–¹æ³•é‡æ–°åŠ è¼‰é…ç½®æ™‚ï¼Œé€™äº›å­—æ®µéœ€è¦è¢«æ‚¨çš„é…ç½®æ¥å—ï¼Œç„¶å¾Œç™¼é€åˆ°è¶…é¡ã€‚

çˆ²æ‚¨çš„é…ç½®å®šç¾© model_typeï¼ˆæ­¤è™•çˆ² model_type="resnet"ï¼‰ä¸æ˜¯å¿…éœ€çš„ï¼Œé™¤éæ‚¨æƒ³å°‡æ‚¨çš„æ¨¡å‹æ³¨å†Šåˆ°è‡ªå‹•é¡ä¸­ï¼ˆè¦‹æœ€å¾Œä¸€ç¯€ï¼‰ã€‚

å®Œæˆæ­¤æ“ä½œå¾Œï¼Œæ‚¨å¯ä»¥åƒè™•ç†åº«ä¸­çš„ä»»ä½•å…¶ä»–æ¨¡å‹é…ç½®ä¸€æ¨£è¼•æ¾åœ°å‰µå»ºå’Œä¿å­˜æ‚¨çš„é…ç½®ã€‚ä»¥ä¸‹æ˜¯æˆ‘å€‘å¦‚ä½•å‰µå»ºä¸€å€‹ resnet50d é…ç½®å¹¶ä¿å­˜å®ƒï¼š

resnet50d_config = ResnetConfig(block_type="bottleneck", stem_width=32, stem_type="deep", avg_down=True)
resnet50d_config.save_pretrained("custom-resnet")
é€™å°‡åœ¨ custom-resnet æ–‡ä»¶å¤¾ä¸­ä¿å­˜ä¸€å€‹åçˆ² config.json çš„æ–‡ä»¶ã€‚ç„¶å¾Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ from_pretrained æ–¹æ³•é‡æ–°åŠ è¼‰æ‚¨çš„é…ç½®

resnet50d_config = ResnetConfig.from_pretrained("custom-resnet")
æ‚¨é‚„å¯ä»¥ä½¿ç”¨ PretrainedConfig é¡çš„ä»»ä½•å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚ push_to_hub()ï¼Œç›´æ¥å°‡æ‚¨çš„é…ç½®ä¸Šå‚³åˆ° Hubã€‚

ç·¨å¯«è‡ªå®šç¾©æ¨¡å‹
ç¾åœ¨æˆ‘å€‘æœ‰äº† ResNet é…ç½®ï¼Œæˆ‘å€‘å¯ä»¥ç¹¼çºŒç·¨å¯«æ¨¡å‹ã€‚æˆ‘å€‘å¯¦éš›ä¸Šæœƒç·¨å¯«å…©å€‹ï¼šä¸€å€‹å¾ä¸€æ‰¹åœ–åƒä¸­æå–éš±è—ç‰¹å¾ï¼ˆä¾‹å¦‚ BertModelï¼‰ï¼Œå¦ä¸€å€‹é©åˆåœ–åƒåˆ†é¡ï¼ˆä¾‹å¦‚ BertForSequenceClassificationï¼‰ã€‚

æ­£å¦‚æˆ‘å€‘ä¹‹å‰æåˆ°çš„ï¼Œæˆ‘å€‘å°‡åªç·¨å¯«æ¨¡å‹çš„æ¾æ•£åŒ…è£å™¨ï¼Œä»¥ä¾¿åœ¨æœ¬ä¾‹ä¸­ä¿æŒç°¡å–®ã€‚åœ¨ç·¨å¯«æ­¤é¡ä¹‹å‰ï¼Œæˆ‘å€‘å”¯ä¸€éœ€è¦åšçš„äº‹æƒ…æ˜¯å¡Šé¡å‹èˆ‡å¯¦éš›å¡Šé¡ä¹‹é–“çš„æ˜ å°„ã€‚ç„¶å¾Œé€šéå°‡æ‰€æœ‰å…§å®¹å‚³éçµ¦ ResNet é¡ä¾†å¾é…ç½®ä¸­å®šç¾©æ¨¡å‹

from transformers import PreTrainedModel
from timm.models.resnet import BasicBlock, Bottleneck, ResNet
from .configuration_resnet import ResnetConfig


BLOCK_MAPPING = {"basic": BasicBlock, "bottleneck": Bottleneck}


class ResnetModel(PreTrainedModel):
    config_class = ResnetConfig

    def __init__(self, config):
        super().__init__(config)
        block_layer = BLOCK_MAPPING[config.block_type]
        self.model = ResNet(
            block_layer,
            config.layers,
            num_classes=config.num_classes,
            in_chans=config.input_channels,
            cardinality=config.cardinality,
            base_width=config.base_width,
            stem_width=config.stem_width,
            stem_type=config.stem_type,
            avg_down=config.avg_down,
        )

    def forward(self, tensor):
        return self.model.forward_features(tensor)
å°äºå°‡å°åœ–åƒé€²è¡Œåˆ†é¡çš„æ¨¡å‹ï¼Œæˆ‘å€‘åªéœ€æ›´æ”¹ forward æ–¹æ³•

import torch


class ResnetModelForImageClassification(PreTrainedModel):
    config_class = ResnetConfig

    def __init__(self, config):
        super().__init__(config)
        block_layer = BLOCK_MAPPING[config.block_type]
        self.model = ResNet(
            block_layer,
            config.layers,
            num_classes=config.num_classes,
            in_chans=config.input_channels,
            cardinality=config.cardinality,
            base_width=config.base_width,
            stem_width=config.stem_width,
            stem_type=config.stem_type,
            avg_down=config.avg_down,
        )

    def forward(self, tensor, labels=None):
        logits = self.model(tensor)
        if labels is not None:
            loss = torch.nn.functional.cross_entropy(logits, labels)
            return {"loss": loss, "logits": logits}
        return {"logits": logits}
åœ¨é€™å…©ç¨®æƒ…æ³ä¸‹ï¼Œè«‹æ³¨æ„æˆ‘å€‘æ˜¯å¦‚ä½•ç¹¼æ‰¿è‡ª PreTrainedModel å¹¶ä½¿ç”¨ config èª¿ç”¨è¶…é¡åˆå§‹åŒ–çš„ï¼ˆæœ‰é»åƒæ‚¨ç·¨å¯«å¸¸è¦ torch.nn.Module æ™‚ï¼‰ã€‚è¨­ç½® config_class çš„è¡Œä¸æ˜¯å¿…éœ€çš„ï¼Œé™¤éæ‚¨æƒ³å°‡æ‚¨çš„æ¨¡å‹æ³¨å†Šåˆ°è‡ªå‹•é¡ä¸­ï¼ˆè¦‹æœ€å¾Œä¸€ç¯€ï¼‰ã€‚

å¦‚æœæ‚¨çš„æ¨¡å‹èˆ‡åº«ä¸­çš„æ¨¡å‹éå¸¸ç›¸ä¼¼ï¼Œæ‚¨å¯ä»¥é‡ç”¨èˆ‡è©²æ¨¡å‹ç›¸åŒçš„é…ç½®ã€‚

æ‚¨å¯ä»¥è®“æ‚¨çš„æ¨¡å‹è¿”å›ä»»ä½•æ‚¨æƒ³è¦çš„å…§å®¹ï¼Œä½†åƒæˆ‘å€‘å° ResnetModelForImageClassification æ‰€åšçš„é‚£æ¨£è¿”å›ä¸€å€‹å­—å…¸ï¼ŒåŒ…æ‹¬å‚³éæ¨™ç°½æ™‚çš„æå¤±ï¼Œå°‡ä½¿æ‚¨çš„æ¨¡å‹å¯ä»¥ç›´æ¥åœ¨ Trainer é¡ä¸­ä½¿ç”¨ã€‚ä½¿ç”¨å…¶ä»–è¼¸å‡ºæ ¼å¼ä¹Ÿå¯ä»¥ï¼Œåªè¦æ‚¨è¨ˆåˆ’ä½¿ç”¨è‡ªå·±çš„è¨“ç·´å¾ªç’°æˆ–å…¶ä»–åº«é€²è¡Œè¨“ç·´ã€‚

ç¾åœ¨æˆ‘å€‘æœ‰äº†æ¨¡å‹é¡ï¼Œè®“æˆ‘å€‘å‰µå»ºä¸€å€‹

resnet50d = ResnetModelForImageClassification(resnet50d_config)
åŒæ¨£ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ PreTrainedModel çš„ä»»ä½•æ–¹æ³•ï¼Œä¾‹å¦‚ save_pretrained() æˆ– push_to_hub()ã€‚æˆ‘å€‘å°‡åœ¨ä¸‹ä¸€ç¯€ä¸­ä½¿ç”¨ç¬¬äºŒå€‹æ–¹æ³•ï¼Œçœ‹çœ‹å¦‚ä½•å°‡æ¨¡å‹æ¬Šé‡èˆ‡æ¨¡å‹ä»£ç¢¼ä¸€èµ·æ¨é€ã€‚ä½†é¦–å…ˆï¼Œè®“æˆ‘å€‘åœ¨æ¨¡å‹ä¸­åŠ è¼‰ä¸€äº›é è¨“ç·´çš„æ¬Šé‡ã€‚

åœ¨æ‚¨è‡ªå·±çš„ç”¨ä¾‹ä¸­ï¼Œæ‚¨å¯èƒ½æœƒåœ¨è‡ªå·±çš„æ•¸æ“šä¸Šè¨“ç·´æ‚¨çš„è‡ªå®šç¾©æ¨¡å‹ã€‚çˆ²äº†åœ¨æœ¬æ•™ç¨‹ä¸­å¿«é€Ÿå®Œæˆï¼Œæˆ‘å€‘å°‡ä½¿ç”¨ resnet50d çš„é è¨“ç·´ç‰ˆæœ¬ã€‚ç”±äºæˆ‘å€‘çš„æ¨¡å‹åªæ˜¯å®ƒçš„åŒ…è£å™¨ï¼Œå› æ­¤å°‡é€™äº›æ¬Šé‡è½‰ç§»éä¾†å°‡å¾ˆå®¹æ˜“

import timm

pretrained_model = timm.create_model("resnet50d", pretrained=True)
resnet50d.model.load_state_dict(pretrained_model.state_dict())
ç¾åœ¨è®“æˆ‘å€‘çœ‹çœ‹å¦‚ä½•ç¡®ä¿ç•¶æˆ‘å€‘åŸ·è¡Œ save_pretrained() æˆ– push_to_hub() æ™‚ï¼Œæ¨¡å‹ä»£ç¢¼ä¹Ÿè¢«ä¿å­˜ã€‚

å°‡å…·æœ‰è‡ªå®šç¾©ä»£ç¢¼çš„æ¨¡å‹æ³¨å†Šåˆ°è‡ªå‹•é¡ä¸­
å¦‚æœæ‚¨æ­£åœ¨ç·¨å¯«æ“´å±• ğŸ¤— Transformers çš„åº«ï¼Œæ‚¨å¯èƒ½å¸Œæœ›æ“´å±•è‡ªå‹•é¡ä»¥åŒ…å«æ‚¨è‡ªå·±çš„æ¨¡å‹ã€‚é€™èˆ‡å°‡ä»£ç¢¼æ¨é€åˆ° Hub ä¸åŒï¼Œå› çˆ²ç”¨æˆ¶éœ€è¦å°å…¥æ‚¨çš„åº«æ‰èƒ½ç²å¾—è‡ªå®šç¾©æ¨¡å‹ï¼ˆèˆ‡å¾ Hub è‡ªå‹•ä¸‹è¼‰æ¨¡å‹ä»£ç¢¼ç›¸åï¼‰ã€‚

åªè¦æ‚¨çš„é…ç½®å…·æœ‰èˆ‡ç¾æœ‰æ¨¡å‹é¡å‹ä¸åŒçš„ model_type å±¬æ€§ï¼Œå¹¶ä¸”æ‚¨çš„æ¨¡å‹é¡å…·æœ‰æ­£ç¡®çš„ config_class å±¬æ€§ï¼Œæ‚¨å°±å¯ä»¥åƒé€™æ¨£å°‡å®ƒå€‘æ·»åŠ åˆ°è‡ªå‹•é¡ä¸­

from transformers import AutoConfig, AutoModel, AutoModelForImageClassification

AutoConfig.register("resnet", ResnetConfig)
AutoModel.register(ResnetConfig, ResnetModel)
AutoModelForImageClassification.register(ResnetConfig, ResnetModelForImageClassification)
è«‹æ³¨æ„ï¼Œå°‡æ‚¨çš„è‡ªå®šç¾©é…ç½®æ³¨å†Šåˆ° AutoConfig æ™‚ä½¿ç”¨çš„ç¬¬ä¸€å€‹åƒæ•¸éœ€è¦èˆ‡æ‚¨çš„è‡ªå®šç¾©é…ç½®çš„ model_type åŒ¹é…ï¼Œè€Œå°‡æ‚¨çš„è‡ªå®šç¾©æ¨¡å‹æ³¨å†Šåˆ°ä»»ä½•è‡ªå‹•æ¨¡å‹é¡æ™‚ä½¿ç”¨çš„ç¬¬ä¸€å€‹åƒæ•¸éœ€è¦èˆ‡é€™äº›æ¨¡å‹çš„ config_class åŒ¹é…ã€‚

å°‡ä»£ç¢¼ç™¼é€åˆ° Hub
æ­¤ API è™•äºå¯¦é©—éšæ®µï¼Œåœ¨æ¥ä¸‹ä¾†çš„ç‰ˆæœ¬ä¸­å¯èƒ½æœƒæœ‰ä¸€äº›ç´°å¾®çš„ç ´å£æ€§æ›´æ”¹ã€‚

é¦–å…ˆï¼Œç¡®ä¿ä½ çš„æ¨¡å‹åœ¨ .py æ–‡ä»¶ä¸­å®Œå…¨å®šç¾©ã€‚å®ƒå¯ä»¥ä¾è³´äºå°å…¶ä»–æ–‡ä»¶çš„ç›¸å°å°å…¥ï¼Œåªè¦æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨åŒä¸€å€‹ç›®éŒ„ä¸­ï¼ˆç›®å‰æˆ‘å€‘ä¸æ”¯æŒå­æ¨¡å¡Šï¼‰ã€‚ä¾‹å¦‚ï¼Œæˆ‘å€‘åœ¨ç•¶å‰å·¥ä½œç›®éŒ„ä¸‹çš„ä¸€å€‹åçˆ² resnet_model çš„æ–‡ä»¶å¤¾ä¸­å®šç¾©ä¸€å€‹ modeling_resnet.py æ–‡ä»¶å’Œä¸€å€‹ configuration_resnet.py æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶åŒ…å« ResnetConfig çš„ä»£ç¢¼ï¼Œè€Œæ¨¡å‹æ–‡ä»¶åŒ…å« ResnetModel å’Œ ResnetModelForImageClassification çš„ä»£ç¢¼ã€‚

.
â””â”€â”€ resnet_model
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ configuration_resnet.py
    â””â”€â”€ modeling_resnet.py
__init__.py å¯ä»¥çˆ²ç©ºï¼Œå®ƒåªæ˜¯ç”¨ä¾†è®“ Python è­˜åˆ¥ resnet_model å¯ä»¥ç”¨ä½œæ¨¡å¡Šã€‚

å¦‚æœå¾åº«ä¸­å¾©åˆ¶æ¨¡å‹æ–‡ä»¶ï¼Œä½ éœ€è¦å°‡æ–‡ä»¶é ‚éƒ¨çš„æ‰€æœ‰ç›¸å°å°å…¥æ›¿æ›çˆ²å¾ transformers åŒ…ä¸­å°å…¥ã€‚

æ³¨æ„ï¼Œä½ å¯ä»¥é‡ç”¨ï¼ˆæˆ–å­é¡åŒ–ï¼‰ç¾æœ‰çš„é…ç½®/æ¨¡å‹ã€‚

è¦èˆ‡ç¤¾å€åˆ†äº«ä½ çš„æ¨¡å‹ï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼šé¦–å…ˆå¾æ–°å‰µå»ºçš„æ–‡ä»¶ä¸­å°å…¥ ResNet æ¨¡å‹å’Œé…ç½®ã€‚

from resnet_model.configuration_resnet import ResnetConfig
from resnet_model.modeling_resnet import ResnetModel, ResnetModelForImageClassification
ç„¶å¾Œï¼Œä½ å¿…é ˆå‘Šè¨´åº«ï¼Œåœ¨ä½¿ç”¨ save_pretrained æ–¹æ³•æ™‚ï¼Œä½ æƒ³å¾©åˆ¶é€™äº›å°è±¡çš„ä»£ç¢¼æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨çµ¦å®šçš„ Auto é¡ï¼ˆç‰¹åˆ¥æ˜¯å°äºæ¨¡å‹ï¼‰æ­£ç¡®æ³¨å†Šå®ƒå€‘ï¼Œåªéœ€é‹è¡Œ

ResnetConfig.register_for_auto_class()
ResnetModel.register_for_auto_class("AutoModel")
ResnetModelForImageClassification.register_for_auto_class("AutoModelForImageClassification")
æ³¨æ„ï¼Œå°äºé…ç½®ä¸éœ€è¦æŒ‡å®š Auto é¡ï¼ˆå®ƒå€‘åªæœ‰ä¸€å€‹ Auto é¡ï¼ŒAutoConfigï¼‰ï¼Œä½†å°äºæ¨¡å‹å‰‡ä¸åŒã€‚ä½ çš„è‡ªå®šç¾©æ¨¡å‹å¯èƒ½é©ç”¨äºè¨±å¤šä¸åŒçš„ä»»å‹™ï¼Œå› æ­¤ä½ éœ€è¦æŒ‡å®šå“ªå€‹ Auto é¡é©åˆä½ çš„æ¨¡å‹ã€‚

å¦‚æœä½ æƒ³å¾©åˆ¶ä»£ç¢¼æ–‡ä»¶ï¼Œè«‹ä½¿ç”¨ register_for_auto_class()ã€‚å¦‚æœä½ æƒ³å¾å¦ä¸€å€‹å€‰åº«çš„ Hub ä¸­ä½¿ç”¨ä»£ç¢¼ï¼Œå‰‡ä¸éœ€è¦èª¿ç”¨å®ƒã€‚åœ¨æœ‰å¤šå€‹ Auto é¡çš„æƒ…æ³ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çµæ§‹ç›´æ¥ä¿®æ”¹ config.json æ–‡ä»¶

"auto_map": {     
	"AutoConfig": "<your-repo-name>--<config-name>",     
	"AutoModel": "<your-repo-name>--<config-name>",
	"AutoModelFor<Task>": "<your-repo-name>--<config-name>",    
},
æ¥ä¸‹ä¾†ï¼Œè®“æˆ‘å€‘åƒä»¥å‰ä¸€æ¨£å‰µå»ºé…ç½®å’Œæ¨¡å‹ã€‚

resnet50d_config = ResnetConfig(block_type="bottleneck", stem_width=32, stem_type="deep", avg_down=True)
resnet50d = ResnetModelForImageClassification(resnet50d_config)

pretrained_model = timm.create_model("resnet50d", pretrained=True)
resnet50d.model.load_state_dict(pretrained_model.state_dict())
ç¾åœ¨ï¼Œè¦å°‡æ¨¡å‹ç™¼é€åˆ° Hubï¼Œè«‹ç¡®ä¿ä½ å·²ç™»éŒ„ã€‚åœ¨çµ‚ç«¯ä¸­é‹è¡Œ

huggingface-cli login
æˆ–åœ¨ç­†è¨˜æœ¬ä¸­é‹è¡Œ

from huggingface_hub import notebook_login

notebook_login()
ç„¶å¾Œï¼Œä½ å¯ä»¥å°‡æ¨¡å‹æ¨é€åˆ°ä½ è‡ªå·±çš„å‘½åç©ºé–“ï¼ˆæˆ–ä½ æ‰€åœ¨çš„çµ„ç¹”ï¼‰ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º

resnet50d.push_to_hub("custom-resnet50d")
é™¤äº†æ¨¡å‹æ¬Šé‡å’Œ JSON æ ¼å¼çš„é…ç½®ä¹‹å¤–ï¼Œé€™é‚„æœƒå°‡ custom-resnet50d æ–‡ä»¶å¤¾ä¸­çš„æ¨¡å‹å’Œé…ç½® .py æ–‡ä»¶å¾©åˆ¶åˆ° Hubã€‚ä½ å¯ä»¥åœ¨ æ¨¡å‹åº« ä¸­æŸ¥çœ‹çµæœã€‚

æœ‰é—œæ¨é€åˆ° Hub æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ï¼Œè«‹æŸ¥çœ‹ åˆ†äº«æ•™ç¨‹ã€‚

ä½¿ç”¨å¸¶æœ‰è‡ªå®šç¾©ä»£ç¢¼çš„æ¨¡å‹
ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å¸¶æœ‰è‡ªå®šç¾©ä»£ç¢¼æ–‡ä»¶çš„å€‰åº«ä¸­çš„é…ç½®ã€æ¨¡å‹æˆ–åˆ†è©å™¨ï¼Œä»¥åŠ Auto é¡å’Œ from_pretrained æ–¹æ³•ã€‚ä¸Šå‚³åˆ° Hub çš„æ‰€æœ‰æ–‡ä»¶å’Œä»£ç¢¼éƒ½æœƒè¢«æƒæä»¥æª¢æŸ¥æƒ¡æ„è»Ÿä»¶ï¼ˆæœ‰é—œæ›´å¤šä¿¡æ¯ï¼Œè«‹åƒé–± Hub å®‰å…¨ æ–‡æª”ï¼‰ï¼Œä½†ä½ ä»æ‡‰å¯©æŸ¥æ¨¡å‹ä»£ç¢¼å’Œä½œè€…ï¼Œä»¥é¿å…åœ¨ä½ çš„æ©Ÿå™¨ä¸ŠåŸ·è¡Œæƒ¡æ„ä»£ç¢¼ã€‚è¨­ç½® trust_remote_code=True ä»¥ä½¿ç”¨å¸¶æœ‰è‡ªå®šç¾©ä»£ç¢¼çš„æ¨¡å‹ã€‚

from transformers import AutoModelForImageClassification

model = AutoModelForImageClassification.from_pretrained("sgugger/custom-resnet50d", trust_remote_code=True)
é‚„å¼·çƒˆå»ºè­°å‚³éä¸€å€‹æäº¤å“ˆå¸Œä½œçˆ² revisionï¼Œä»¥ç¡®ä¿æ¨¡å‹çš„ä½œè€…æ²’æœ‰ä½¿ç”¨ä¸€äº›æƒ¡æ„çš„æ–°è¡Œæ›´æ–°ä»£ç¢¼ï¼ˆé™¤éä½ å®Œå…¨ä¿¡ä»»æ¨¡å‹çš„ä½œè€…ï¼‰ã€‚

commit_hash = "ed94a7c6247d8aedce4647f00f20de6875b5b292"
model = AutoModelForImageClassification.from_pretrained(
    "sgugger/custom-resnet50d", trust_remote_code=True, revision=commit_hash
)
æ³¨æ„ï¼Œåœ¨æµè¦½ Hub ä¸Šæ¨¡å‹å€‰åº«çš„æäº¤æ­·å²æ™‚ï¼Œæœ‰ä¸€å€‹æŒ‰éˆ•å¯ä»¥è¼•æ¾å¾©åˆ¶ä»»ä½•æäº¤çš„æäº¤å“ˆå¸Œã€‚
